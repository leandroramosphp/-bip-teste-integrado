package com.example.backend.ejb;

import com.example.ejb.entity.Beneficio;

import jakarta.ejb.TransactionAttribute;
import jakarta.ejb.TransactionAttributeType;
import jakarta.persistence.EntityManager;
import jakarta.persistence.LockModeType;
import jakarta.persistence.PersistenceContext;
import java.math.BigDecimal;

@Service
public class BeneficioEjbService {

    @PersistenceContext
    private EntityManager em;

   
    public void transferir(Long origem, Long destino, BigDecimal valor) {

        if (valor == null || valor.compareTo(BigDecimal.ZERO) <= 0) {
            throw new IllegalArgumentException("Valor inválido");
        }

        Beneficio origemEnt =
            em.find(Beneficio.class, origem, LockModeType.OPTIMISTIC);

        Beneficio destinoEnt =
            em.find(Beneficio.class, destino, LockModeType.OPTIMISTIC);

        if (origemEnt == null || destinoEnt == null) {
            throw new RuntimeException("Benefício não encontrado");
        }

        if (origemEnt.getSaldo().compareTo(valor) < 0) {
            throw new RuntimeException("Saldo insuficiente");
        }

        origemEnt.debitar(valor);
        destinoEnt.creditar(valor);
    }

    @Transactional(rollbackFor = Exception.class)
    public void transferir(TransferenciaDTO dto) {

    if (dto == null) {
        throw new IllegalArgumentException("DTO não pode ser nulo");
    }

    transferir(
        dto.getOrigemId(),
        dto.getDestinoId(),
        dto.getValor()
    );
}

}
